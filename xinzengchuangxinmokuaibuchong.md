现有模块问题1:
模块1子问题1.1,单一尺度处理,无法适应不同时间尺度的模式 

真实世界的时间序列数据往往呈现多尺度特性：
- 微观尺度：高频波动、噪声、短期突变
- 中观尺度：日内周期、工作日模式
- 宏观尺度：长期趋势、季节性变化
模块1子问题1.2,缺乏层级趋势感知,接预测具体数值，未先判断趋势方向 , 在趋势转折点处预测偏差大 

人类专家在进行时序预测时，通常遵循以下认知过程：
1. 首先判断整体趋势方向（上涨/下降/平稳）
2. 然后估计变化幅度的大致范围
3. 最后细化具体数值预测
趋势判别 → 幅度估计 → 数值细化.
第一层：方向判断 → "明天股价会涨还是跌？" (二分类)
第二层：幅度估计 → "大概涨/跌多少个百分点？" (粗粒度回归)
第三层：数值预测 → "具体价格是多少？" (细粒度回归)
这种渐进式细化的预测范式在计算机视觉领域已被广泛验证有效 ，但尚未在LLM-based时序预测中得到充分探索。
模块问题2:
模块2子问题2.1,历史模式利用不足:仅使用当前窗口数据，未充分利用全局历史模式 ,对周期性模式捕获能力有限 
模块2子问题2.2,对于是听从历史经验”还是“依赖当前推理”的门控,阈值,都需要进行相应的学习以进行有效抉择。

- **相似模式检索**：从历史数据库中检索与当前输入最相似的K个模式
- **历史参考融合**：将检索到的历史模式及其后续发展作为参考信息
- **预测增强**：结合模型预测与历史参考，输出更稳健的结果



解决问题1,学术创新点总结:
1. 层级决策机制: 首次在LLM-based时序预测中引入"粗到细"的层级预测策略
2. 条件幅度回归: 基于趋势类别条件的幅度预测，提升回归精度
3. 可学习阈值: 自适应学习趋势划分阈值，适应不同数据集特性
4. 可解释性增强: 趋势分类结果提供直观的预测解释
5. 多尺度特征融合: 自适应融合不同时间分辨率的特征表示
解决问题2,学术创新点总结.
1. 检索增强预测: 首次将检索增强机制与LLM-based时序预测结合
2. 自适应门控融合: 动态平衡模型预测与检索预测的贡献
3. 历史模式利用: 充分挖掘训练集中的相似历史模式


实现模式:
TAPR和GRA-M可以协同工作，形成完整的增强预测流程：
代码架构
```
Time-LLM/
├── layers/
│   ├── TAPR.py
        ├──
        ├──
        ...
│   │
│   └── GRA-M.py 
        ├──
        ├──
        ...
└── models/
    └── TimeLLM.py                           # 修改：集成新模块
```
**具体流程图如下, 二者进行参考**
**流程图一-层次架构**
```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Time-LLM +TAPR  +GRA-M  层次架构                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入时序 x_enc                                                         │
│       │                                                                 │
│       ▼                                                                 │
│  ┌──────────────────────────────────────────────────┐                  │
│  │                Time-LLM Backbone                  │                  │
│  │  [Patching] → [Reprogramming] → [Frozen LLM]     │                  │
│  └────────────────────────┬─────────────────────────┘                  │
│                           │                                             │
│                           ▼ LLM Features                                │
│       ┌───────────────────┴───────────────────┐                        │
│       │                                       │                        │
│       ▼                                       ▼                        │
│  ┌──────────────┐                      ┌──────────────┐               │
│  │     PGPM     │                      │     RAPM     │               │
│  │  渐进式粒度   │                      │  检索增强    │               │
│  │  预测模块     │                      │  模式匹配    │               │
│  └──────┬───────┘                      └──────┬───────┘               │
│         │                                     │                        │
│         │ Direction+Magnitude+Precise         │ Retrieved Reference     │
│         │                                     │                        │
│         └─────────────────┬───────────────────┘                        │
│                           │                                             │
│                           ▼                                             │
│                    ┌──────────────┐                                    │
│                    │   Final      │                                    │
│                    │   Ensemble   │                                    │
│                    │   Fusion     │                                    │
│                    └──────┬───────┘                                    │
│                           │                                             │
│                           ▼                                             │
│                    最终预测输出                                          │
│                    [B, pred_len, N]                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
**流程图二-协同架构**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│            Time-LLM +TAPR + GRA-M 协同架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入时序 x_enc [B, T, N]                                                   │
│       │                                                                     │
│       ├───────────────────┬───────────────────┐                            │
│       │                   │                   │                            │
│       ▼                   ▼                   ▼                            │
│  [TAPR模块]          [GRA-M模块]         [原Time-LLM]                       │
│  多尺度趋势感知       检索相似历史        Patch嵌入+重编程                   │
│       │                   │                   │                            │
│       ▼                   ▼                   ▼                            │
│  Trend_embed         Retrieved_info       Patch_embed                      │
│       │                   │                   │                            │
│       └───────────────────┴───────────────────┘                            │
│                           │                                                │
│                           ▼                                                │
│              ┌────────────────────────────┐                                │
│              │   Enhanced Prompt 构建     │                                │
│              │                            │                                │
│              │ [Trend_embed,              │                                │
│              │  Statistical_prompt,       │                                │
│              │  Retrieved_context,        │                                │
│              │  Patch_embed]              │                                │
│              └────────────────────────────┘                                │
│                           │                                                │
│                           ▼                                                │
│              ┌────────────────────────────┐                                │
│              │     Frozen LLM Forward     │                                │
│              └────────────────────────────┘                                │
│                           │                                                │
│                           ▼                                                │
│              ┌────────────────────────────┐                                │
│              │   Output Projection        │                                │
│              │   + Retrieval-Guided       │                                │
│              │     Refinement             │                                │
│              └────────────────────────────┘                                │
│                           │                                                │
│                           ▼                                                │
│                    最终预测输出                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
**可参考的具体模块设计**
```
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ TAPR（Trend-Aware Patch Router,趋势感知尺度路由）                   
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入时序 x_enc [B, T, N]                                                   │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │            Stage 1: 多尺度趋势特征提取                                │    │
│  │  ┌─────────────┬─────────────┬─────────────┐                        │    │
│  │  │ Scale 1 (1x) │ Scale 2 (4x)│ Scale 3 (16x)│                       │    │
│  │  │ 原始序列     │ 4x下采样    │ 16x下采样     │                       │    │
│  │  │ 细粒度波动   │ 中期趋势    │ 长期趋势      │                       │    │
│  │  └──────┬──────┴──────┬──────┴──────┬──────┘                        │    │
│  │         │             │             │                                │    │
│  │         ▼             ▼             ▼                                │    │
│  │    [Conv1D+GeLU] [Conv1D+GeLU] [Conv1D+GeLU]                         │    │
│  │         │             │             │                                │    │
│  │         └──────┬──────┴──────┬──────┘                                │    │
│  │                │             │                                       │    │
│  │                ▼             ▼                                       │    │
│  │       Trend_feat_fine  Trend_feat_coarse                             │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                │                                                            │
│                ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │            Stage 2: 层级趋势分类                                      │    │
│  │                                                                      │    │
│  │  Level 1 (二分类): 上涨 vs 下跌                                       │    │
│  │       │                                                              │    │
│  │       ▼                                                              │    │
│  │  Level 2 (四分类): 强上涨/弱上涨/弱下跌/强下跌                         │    │
│  │       │                                                              │    │
│  │       ▼                                                              │    │
│  │  Level 3 (细分类): 细粒度趋势强度分类                                  │    │
│  │                                                                      │    │
│  │  ─────────────────────────────────────────────────────────          │    │
│  │  辅助损失: L_trend = CE(pred_trend, true_trend) + λ·L_consistency    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                │                                                            │
│                ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │            Stage 3: 趋势引导的预测融合                                │    │
│  │                                                                      │    │
│  │  Trend_embedding = Embed(predicted_trend_class)                      │    │
│  │       │                                                              │    │
│  │       ▼                                                              │    │
│  │  [与Time-LLM的Prompt前缀拼接]                                         │    │
│  │       │                                                              │    │
│  │       ▼                                                              │    │
│  │  Enhanced_prompt = [Trend_embed, Statistical_prompt, Patch_embed]    │    │
│  │       │                                                              │    │
│  │       ▼                                                              │    │
│  │  [送入冻结的LLM进行预测]                                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  输出: 预测值 + 趋势分类结果                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```
```
┌─────────────────────────────────────────────────────────────────────────────┐
│    GRA-M (Global Retrieval-Augmented Memory, 全局检索增强记忆网络)       
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │               离线阶段: 构建历史模式库                                 │   │
│  │                                                                      │   │
│  │  训练数据集 X_train                                                  │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  [滑动窗口采样] → 获取所有历史片段 {x_i, y_i}                         │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  [对比学习编码器] → 计算每个片段的表征向量 e_i                        │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  [FAISS索引构建] → 高效相似度检索数据库                               │   │
│  │                                                                      │   │
│  │  Memory Bank: {(e_1, y_1), (e_2, y_2), ..., (e_M, y_M)}             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │               在线阶段: 检索增强预测                                   │   │
│  │                                                                      │   │
│  │  当前输入 x_query [B, T, N]                                          │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  [Query Encoder] → 计算查询表征 q [B, d_repr]                        │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────┐         │   │
│  │  │            Top-K 相似模式检索                            │         │   │
│  │  │                                                          │         │   │
│  │  │  对每个样本:                                             │         │   │
│  │  │    1. 在Memory Bank中检索Top-K最相似的历史片段           │         │   │
│  │  │    2. 获取这些片段对应的真实未来值 {y_k1, y_k2, ..., y_kK} │         │   │
│  │  │    3. 计算相似度权重 {w_1, w_2, ..., w_K}                │         │   │
│  │  └─────────────────────────────────────────────────────────┘         │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────┐         │   │
│  │  │            检索信息融合                                  │         │   │
│  │  │                                                          │         │   │
│  │  │  retrieved_reference = Σ w_k · y_k  (加权平均参考值)     │         │   │
│  │  │       │                                                  │         │   │
│  │  │       ▼                                                  │         │   │
│  │  │  [Cross-Attention Fusion]                                │         │   │
│  │  │    Query: 当前输入的Patch嵌入                            │         │   │
│  │  │    Key/Value: 检索到的历史模式嵌入                       │         │   │
│  │  │       │                                                  │         │   │
│  │  │       ▼                                                  │         │   │
│  │  │  [Gated Fusion]                                          │         │   │
│  │  │    gate = σ(W · [current_feat, retrieved_feat])         │         │   │
│  │  │    fused = gate · current + (1-gate) · retrieved        │         │   │
│  │  └─────────────────────────────────────────────────────────┘         │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  融合后的表征 → [继续Time-LLM的后续处理]                             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  输出: 检索增强后的预测值                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```



```
┌─────────────────────────────────────────────────────────────────────┐
│                    Progressive Granularity Prediction Module         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  LLM Output Embeddings                                              │
│  [B*N, L, d_ff]                                                     │
│         │                                                            │
│         ├─────────────────┬─────────────────┬────────────────┐      │
│         ▼                 ▼                 ▼                │      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │      │
│  │   Coarse     │  │   Medium     │  │    Fine      │       │      │
│  │   Encoder    │  │   Encoder    │  │   Encoder    │       │      │
│  │  (Trend)     │  │ (Magnitude)  │  │  (Precise)   │       │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │      │
│         │                 │                 │                │      │
│         ▼                 ▼                 ▼                │      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │      │
│  │  Direction   │  │  Magnitude   │  │   Value      │       │      │
│  │  Classifier  │  │  Estimator   │  │  Regressor   │       │      │
│  │  (↑/↓/→)     │  │  (幅度区间)   │  │  (精确值)    │       │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │      │
│         │                 │                 │                │      │
│         │    ┌────────────┘                 │                │      │
│         │    │                              │                │      │
│         ▼    ▼                              ▼                │      │
│  ┌────────────────┐                  ┌──────────────┐       │      │
│  │   Constraint   │─────────────────▶│   Gated      │       │      │
│  │   Propagation  │                  │   Fusion     │       │      │
│  └────────────────┘                  └──────┬───────┘       │      │
│                                             │                │      │
│                                             ▼                │      │
│                                     Final Prediction         │      │
│                                     [B, pred_len, N]         │      │
│                                                              │      │
└─────────────────────────────────────────────────────────────────────┘
```
```
Time-LLM Embeddings
        │
        ▼
┌───────────────────┐
│  Pattern Encoder  │ ──────────────┐
│  (学习可检索表示)  │               │
└─────────┬─────────┘               │
          │                         │
          ▼                         ▼
┌───────────────────┐    ┌───────────────────┐
│  Retrieval Index  │    │  Current Query    │
│  (历史模式库)      │◄───│  (当前输入表示)    │
└─────────┬─────────┘    └───────────────────┘
          │
          ▼
┌───────────────────┐
│  Top-K Similar    │
│  Patterns         │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  Reference Fusion │
│  (参考融合)        │
└─────────┬─────────┘
          │
          ▼
   Enhanced Prediction
```

```
┌────────────────────────────────────────────────────────────────────────┐
│   GRA-M (Global Retrieval-Augmented Memory, 全局检索增强记忆网络)          │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    Pattern Memory Bank                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │  │
│  │  │ Pattern 1   │  │ Pattern 2   │  │ Pattern K   │    ...      │  │
│  │  │ [input|fut] │  │ [input|fut] │  │ [input|fut] │             │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘             │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                              ▲                                         │
│                              │ 检索                                    │
│  Current Input               │                                         │
│  [B*N, L, d_ff]              │                                         │
│       │                      │                                         │
│       ▼                      │                                         │
│  ┌──────────────┐    ┌──────────────┐                                │  │
│  │   Pattern    │───▶│   KNN        │                                │  │
│  │   Encoder    │    │   Retriever  │                                │  │
│  └──────────────┘    └──────┬───────┘                                │  │
│                             │                                         │
│                             ▼ Top-K Patterns                          │
│                      ┌──────────────┐                                 │
│                      │  Retrieved   │                                 │
│                      │  Patterns    │                                 │
│                      │  [K, L+P, d] │                                 │
│                      └──────┬───────┘                                 │
│                             │                                         │
│       ┌─────────────────────┼─────────────────────┐                  │
│       │                     │                     │                  │
│       ▼                     ▼                     ▼                  │
│  ┌──────────┐        ┌──────────┐          ┌──────────┐             │
│  │ History  │        │ Future   │          │ Similar- │             │
│  │ Context  │        │ Reference│          │ ity      │             │
│  │ Encoder  │        │ Decoder  │          │ Weights  │             │
│  └────┬─────┘        └────┬─────┘          └────┬─────┘             │
│       │                   │                     │                    │
│       └───────────────────┼─────────────────────┘                    │
│                           │                                          │
│                           ▼                                          │
│                    ┌──────────────┐                                  │
│                    │   Weighted   │                                  │
│                    │   Reference  │                                  │
│                    │   Fusion     │                                  │
│                    └──────┬───────┘                                  │
│                           │                                          │
│       ┌───────────────────┼───────────────────┐                      │
│       │                   │                   │                      │
│       ▼                   ▼                   ▼                      │
│  ┌──────────┐      ┌──────────────┐    ┌──────────────┐             │
│  │  Model   │      │   Gated      │    │   Residual   │             │
│  │  Output  │─────▶│   Combine    │◄───│   Reference  │             │
│  └──────────┘      └──────┬───────┘    └──────────────┘             │
│                           │                                          │
│                           ▼                                          │
│                   Enhanced Prediction                                │
│                   [B, pred_len, N]                                   │
│                                                                      │
└────────────────────────────────────────────────────────────────────────┘
```
消融实验设计

| 实验编号 | 配置 | 目的 |
|---------|------|------|
| E1 | Time-LLM (baseline) | 基线对比 |
| E2 | Time-LLM +TAPR | 验证HTPM独立效果 |
| E3 | Time-LLM + GRA-M | 验证GRA-M独立效果 |
| E4 | Time-LLM +TAPR + GRA-M | 验证两模块协同效果 |